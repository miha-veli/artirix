{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "36f27655-c4ae-407e-9185-381293f6bb93": {
        "size": {
          "width": 680,
          "height": 590
        },
        "position": {
          "x": 120,
          "y": 120
        },
        "z": 1,
        "embeds": [
          "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754",
          "aab61a65-9b7c-4906-80f2-8eaea438557f",
          "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93",
          "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
          "9c17329e-4f0e-498c-83c3-c039080890ae"
        ]
      },
      "efdb307b-1972-4dd1-8755-85726629a1d5": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": -10
        },
        "z": 1,
        "embeds": []
      },
      "d03f5fa0-6289-41e3-95ec-5c2d1a29454b": {
        "source": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        },
        "target": {
          "id": "36f27655-c4ae-407e-9185-381293f6bb93"
        },
        "z": 1
      },
      "9c17329e-4f0e-498c-83c3-c039080890ae": {
        "size": {
          "width": 220,
          "height": 120
        },
        "position": {
          "x": 160,
          "y": 170
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "dea40fb2-4fff-4269-b920-c2a835260ce2",
          "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        ]
      },
      "86f119d8-9e7c-4a19-b17b-ed664b9e73f0": {
        "size": {
          "width": 350,
          "height": 140
        },
        "position": {
          "x": 140,
          "y": 470
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "6bb5f648-cc4b-443d-a76d-ed727afa58d4",
          "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d",
          "88279449-ada4-404c-8850-88f539acedbb"
        ]
      },
      "dea40fb2-4fff-4269-b920-c2a835260ce2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 200
        },
        "z": 3,
        "parent": "9c17329e-4f0e-498c-83c3-c039080890ae",
        "embeds": []
      },
      "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 180,
          "y": 200
        },
        "z": 3,
        "parent": "9c17329e-4f0e-498c-83c3-c039080890ae",
        "embeds": [],
        "isrelatedto": [
          "dea40fb2-4fff-4269-b920-c2a835260ce2"
        ]
      },
      "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93": {
        "size": {
          "width": 120,
          "height": 120
        },
        "position": {
          "x": 490,
          "y": 170
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        ]
      },
      "1abf5360-b03d-4e60-81d3-ae316698c8cc": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 520,
          "y": 200
        },
        "z": 3,
        "parent": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93",
        "embeds": [],
        "references": [
          "efdb307b-1972-4dd1-8755-85726629a1d5"
        ]
      },
      "e2ddbc28-69e3-43df-8b74-78c38037c746": {
        "source": {
          "id": "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        },
        "target": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        },
        "z": 4
      },
      "ef869242-a412-4346-973c-a531e3d98d8a": {
        "source": {
          "id": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93"
        },
        "target": {
          "id": "9c17329e-4f0e-498c-83c3-c039080890ae"
        },
        "z": 2
      },
      "88279449-ada4-404c-8850-88f539acedbb": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 190,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "6bb5f648-cc4b-443d-a76d-ed727afa58d4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "aab61a65-9b7c-4906-80f2-8eaea438557f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 630
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": []
      },
      "98e54072-e70d-48d8-a138-e79e6b38372b": {
        "source": {
          "id": "88279449-ada4-404c-8850-88f539acedbb"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 4
      },
      "4a82b339-b237-4a63-bb34-6500a11d558c": {
        "source": {
          "id": "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 5
      },
      "ccad5f40-b451-4833-8dbd-2c82ea868666": {
        "source": {
          "id": "6bb5f648-cc4b-443d-a76d-ed727afa58d4"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 6
      },
      "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754": {
        "size": {
          "width": 129.18750484336726,
          "height": 140
        },
        "position": {
          "x": 570,
          "y": 470
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "edc623d7-287d-463c-8da4-d26285107199"
        ]
      },
      "edc623d7-287d-463c-8da4-d26285107199": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 600,
          "y": 510
        },
        "z": 3,
        "parent": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754",
        "embeds": [],
        "isrelatedto": [
          "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        ]
      },
      "60aaa6dc-1a58-4292-ad04-e7c603e06e05": {
        "source": {
          "id": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754"
        },
        "target": {
          "id": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0"
        },
        "z": 2
      }
    }
  },
  "Resources": {
    "elasticSearchVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {
          "Ref": "elasticSearchCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "Elastic Search VPC"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "36f27655-c4ae-407e-9185-381293f6bb93"
        }
      }
    },
    "EC2VPCG1FYBK": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "elasticSearchIGW"
        },
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d03f5fa0-6289-41e3-95ec-5c2d1a29454b"
        }
      }
    },
    "elasticSearchIGW": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        }
      }
    },
    "elasticSearchPublicSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "AvailabilityZone": {
          "Ref": "availabilityZone"
        },
        "CidrBlock": {
          "Ref": "publicESCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ElasticSearch public network"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "9c17329e-4f0e-498c-83c3-c039080890ae"
        }
      }
    },
    "elasticSearchPrivateSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "AvailabilityZone": {
          "Ref": "availabilityZone"
        },
        "CidrBlock": {
          "Ref": "privateESCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ElasticSearch private network"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0"
        }
      }
    },
    "elasticSearchNATEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "dea40fb2-4fff-4269-b920-c2a835260ce2"
        }
      }
    },
    "elasticSearchNAT": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPublicSubnet"
        },
        "AllocationId": {
          "Fn::GetAtt": [
            "elasticSearchNATEIP",
            "AllocationId"
          ]
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        }
      }
    },
    "elasticSearchPublicRoutingTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93"
        }
      }
    },
    "elasticSearchPublicToInternet": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPublicRoutingTable"
        },
        "GatewayId": {
          "Ref": "elasticSearchIGW"
        },
        "DestinationCidrBlock": "0.0.0.0/0"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        }
      }
    },
    "EC2SRTA2Z4YE": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPublicRoutingTable"
        },
        "SubnetId": {
          "Ref": "elasticSearchPublicSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ef869242-a412-4346-973c-a531e3d98d8a"
        }
      }
    },
    "elasticSearch1": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es1.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "88279449-ada4-404c-8850-88f539acedbb"
        }
      }
    },
    "elasticSearch2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es2.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d"
        }
      }
    },
    "elasticSearch3": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es3.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6bb5f648-cc4b-443d-a76d-ed727afa58d4"
        }
      }
    },
    "elasticSearchSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "GroupDescription": "Elastic Search internal traffic",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Ref": "elasticSearchCIDR"
            },
            "IpProtocol": "-1"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        }
      }
    },
    "elasticSearchPrivateRoutingTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754"
        }
      }
    },
    "elasticSearchPrivateToInternet": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPrivateRoutingTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "elasticSearchNAT"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "edc623d7-287d-463c-8da4-d26285107199"
        }
      }
    },
    "EC2SRTA3LBEE": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPrivateRoutingTable"
        },
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "60aaa6dc-1a58-4292-ad04-e7c603e06e05"
        }
      }
    }
  },
  "Parameters": {
    "availabilityZone": {
      "Type": "String"
    },
    "privateESCIDR": {
      "Type": "String"
    },
    "publicESCIDR": {
      "Type": "String"
    },
    "elasticSearchCIDR": {
      "Type": "String"
    },
    "elasticSearchAMI": {
      "Type": "String"
    },
    "elasticSearchInstanceType": {
      "Type": "String"
    },
    "env": {
      "Type": "String"
    },
    "keyPairName": {
      "Type": "String"
    }
  }
}