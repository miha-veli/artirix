{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "36f27655-c4ae-407e-9185-381293f6bb93": {
        "size": {
          "width": 680,
          "height": 590
        },
        "position": {
          "x": 120,
          "y": 120
        },
        "z": 1,
        "embeds": [
          "b8e5368e-f7ee-4fc0-90a9-319d4c4382f5",
          "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754",
          "aab61a65-9b7c-4906-80f2-8eaea438557f",
          "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93",
          "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
          "c47bdcca-003b-4704-b1b3-8bc050d64085",
          "9c17329e-4f0e-498c-83c3-c039080890ae"
        ]
      },
      "efdb307b-1972-4dd1-8755-85726629a1d5": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": -10
        },
        "z": 1,
        "embeds": []
      },
      "d03f5fa0-6289-41e3-95ec-5c2d1a29454b": {
        "source": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        },
        "target": {
          "id": "36f27655-c4ae-407e-9185-381293f6bb93"
        },
        "z": 1
      },
      "9c17329e-4f0e-498c-83c3-c039080890ae": {
        "size": {
          "width": 220,
          "height": 120
        },
        "position": {
          "x": 160,
          "y": 170
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "dea40fb2-4fff-4269-b920-c2a835260ce2",
          "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        ]
      },
      "86f119d8-9e7c-4a19-b17b-ed664b9e73f0": {
        "size": {
          "width": 350,
          "height": 140
        },
        "position": {
          "x": 140,
          "y": 470
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "6bb5f648-cc4b-443d-a76d-ed727afa58d4",
          "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d",
          "88279449-ada4-404c-8850-88f539acedbb"
        ]
      },
      "dea40fb2-4fff-4269-b920-c2a835260ce2": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 200
        },
        "z": 3,
        "parent": "9c17329e-4f0e-498c-83c3-c039080890ae",
        "embeds": []
      },
      "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 180,
          "y": 200
        },
        "z": 3,
        "parent": "9c17329e-4f0e-498c-83c3-c039080890ae",
        "embeds": [],
        "isrelatedto": [
          "dea40fb2-4fff-4269-b920-c2a835260ce2"
        ]
      },
      "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93": {
        "size": {
          "width": 120,
          "height": 120
        },
        "position": {
          "x": 490,
          "y": 170
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        ]
      },
      "1abf5360-b03d-4e60-81d3-ae316698c8cc": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 520,
          "y": 200
        },
        "z": 3,
        "parent": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93",
        "embeds": [],
        "references": [
          "efdb307b-1972-4dd1-8755-85726629a1d5"
        ]
      },
      "e2ddbc28-69e3-43df-8b74-78c38037c746": {
        "source": {
          "id": "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        },
        "target": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        },
        "z": 4
      },
      "ef869242-a412-4346-973c-a531e3d98d8a": {
        "source": {
          "id": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93"
        },
        "target": {
          "id": "9c17329e-4f0e-498c-83c3-c039080890ae"
        },
        "z": 2
      },
      "88279449-ada4-404c-8850-88f539acedbb": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 190,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "6bb5f648-cc4b-443d-a76d-ed727afa58d4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 390,
          "y": 510
        },
        "z": 3,
        "parent": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0",
        "embeds": [],
        "ismemberof": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ],
        "isrelatedto": [
          "aab61a65-9b7c-4906-80f2-8eaea438557f"
        ]
      },
      "aab61a65-9b7c-4906-80f2-8eaea438557f": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 630
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": []
      },
      "98e54072-e70d-48d8-a138-e79e6b38372b": {
        "source": {
          "id": "88279449-ada4-404c-8850-88f539acedbb"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 4
      },
      "4a82b339-b237-4a63-bb34-6500a11d558c": {
        "source": {
          "id": "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 5
      },
      "ccad5f40-b451-4833-8dbd-2c82ea868666": {
        "source": {
          "id": "6bb5f648-cc4b-443d-a76d-ed727afa58d4"
        },
        "target": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        },
        "z": 6
      },
      "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754": {
        "size": {
          "width": 210,
          "height": 140
        },
        "position": {
          "x": 570,
          "y": 470
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [
          "6c1ca4ea-f6ac-4359-b417-c18a7e0dec76",
          "edc623d7-287d-463c-8da4-d26285107199"
        ]
      },
      "edc623d7-287d-463c-8da4-d26285107199": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 600,
          "y": 510
        },
        "z": 3,
        "parent": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754",
        "embeds": [],
        "isrelatedto": [
          "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        ]
      },
      "60aaa6dc-1a58-4292-ad04-e7c603e06e05": {
        "source": {
          "id": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754"
        },
        "target": {
          "id": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0"
        },
        "z": 2
      },
      "c47bdcca-003b-4704-b1b3-8bc050d64085": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": 370
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": [],
        "isconnectedto": [
          "6bb5f648-cc4b-443d-a76d-ed727afa58d4",
          "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d",
          "88279449-ada4-404c-8850-88f539acedbb",
          "9c17329e-4f0e-498c-83c3-c039080890ae"
        ],
        "ismemberof": [
          "b8e5368e-f7ee-4fc0-90a9-319d4c4382f5"
        ]
      },
      "3bd5f508-f454-4477-bddb-91596687151b": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "6bb5f648-cc4b-443d-a76d-ed727afa58d4"
        },
        "z": 4
      },
      "c6e98883-9ba3-4558-ad0d-552e8b8a4b51": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d"
        },
        "z": 5
      },
      "57100106-be4c-41fd-a48e-eafd6aa6690f": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "88279449-ada4-404c-8850-88f539acedbb"
        },
        "z": 6
      },
      "3c5bb106-7794-4dbb-93b8-ff358b0ff421": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0"
        },
        "z": 4
      },
      "b8e5368e-f7ee-4fc0-90a9-319d4c4382f5": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 190,
          "y": 370
        },
        "z": 2,
        "parent": "36f27655-c4ae-407e-9185-381293f6bb93",
        "embeds": []
      },
      "e3bf84b9-0309-451e-8804-8af6ced887e8": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "b8e5368e-f7ee-4fc0-90a9-319d4c4382f5"
        },
        "z": 4
      },
      "a18d69fd-8bab-477b-b86c-6350da5fdd1a": {
        "size": {
          "width": 710,
          "height": 320
        },
        "position": {
          "x": 1010,
          "y": 260
        },
        "z": 0,
        "embeds": [
          "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e",
          "551146b6-9da7-4507-b56a-169a698b8a74",
          "e34b83d8-b7cc-4f09-9e93-ad43a4687f39"
        ]
      },
      "e34b83d8-b7cc-4f09-9e93-ad43a4687f39": {
        "size": {
          "width": 280,
          "height": 130
        },
        "position": {
          "x": 1370,
          "y": 310
        },
        "z": 1,
        "parent": "a18d69fd-8bab-477b-b86c-6350da5fdd1a",
        "embeds": [
          "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a",
          "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4"
        ]
      },
      "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1420,
          "y": 350
        },
        "z": 2,
        "parent": "e34b83d8-b7cc-4f09-9e93-ad43a4687f39",
        "embeds": [],
        "ismemberof": [
          "551146b6-9da7-4507-b56a-169a698b8a74"
        ],
        "dependson": [
          "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a"
        ]
      },
      "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1540,
          "y": 350
        },
        "z": 2,
        "parent": "e34b83d8-b7cc-4f09-9e93-ad43a4687f39",
        "embeds": []
      },
      "4a1a9faa-5c5c-40b2-8bbf-ccd05e679abe": {
        "source": {
          "id": "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a"
        },
        "target": {
          "id": "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4"
        },
        "z": 2
      },
      "551146b6-9da7-4507-b56a-169a698b8a74": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1420,
          "y": 480
        },
        "z": 1,
        "parent": "a18d69fd-8bab-477b-b86c-6350da5fdd1a",
        "embeds": []
      },
      "022333b2-36b7-49ee-94f9-7fed76091477": {
        "source": {
          "id": "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4"
        },
        "target": {
          "id": "551146b6-9da7-4507-b56a-169a698b8a74"
        },
        "z": 4
      },
      "0ce14ddf-1960-435a-a4f4-5212a93321ad": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1340,
          "y": 90
        },
        "z": 0,
        "embeds": []
      },
      "a5158102-ea7d-4b41-8efa-f94cc5ff8c0f": {
        "source": {
          "id": "0ce14ddf-1960-435a-a4f4-5212a93321ad"
        },
        "target": {
          "id": "a18d69fd-8bab-477b-b86c-6350da5fdd1a"
        },
        "z": 0
      },
      "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e": {
        "size": {
          "width": 240,
          "height": 130
        },
        "position": {
          "x": 1070,
          "y": 310
        },
        "z": 1,
        "parent": "a18d69fd-8bab-477b-b86c-6350da5fdd1a",
        "embeds": [
          "ce415937-fc09-48d1-98fd-809f3e05005e",
          "204bcb90-a980-47be-988e-82b9cb8728ff"
        ]
      },
      "b03e3f82-bf90-4607-ab2b-eb6b54826fd6": {
        "source": {
          "id": "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e"
        },
        "target": {
          "id": "e34b83d8-b7cc-4f09-9e93-ad43a4687f39"
        },
        "z": 1
      },
      "ce415937-fc09-48d1-98fd-809f3e05005e": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1220,
          "y": 340
        },
        "z": 2,
        "parent": "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e",
        "embeds": [],
        "references": [
          "0ce14ddf-1960-435a-a4f4-5212a93321ad"
        ]
      },
      "ae714f4f-150a-4131-b713-6dde363fa0f1": {
        "source": {
          "id": "ce415937-fc09-48d1-98fd-809f3e05005e"
        },
        "target": {
          "id": "0ce14ddf-1960-435a-a4f4-5212a93321ad"
        },
        "z": 4
      },
      "6764dff7-08a4-419e-8209-f3bbf436cfa2": {
        "source": {
          "id": "36f27655-c4ae-407e-9185-381293f6bb93"
        },
        "target": {
          "id": "a18d69fd-8bab-477b-b86c-6350da5fdd1a"
        },
        "z": 1
      },
      "204bcb90-a980-47be-988e-82b9cb8728ff": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 1110,
          "y": 340
        },
        "z": 2,
        "parent": "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e",
        "embeds": [],
        "references": [
          "6764dff7-08a4-419e-8209-f3bbf436cfa2"
        ]
      },
      "6c1ca4ea-f6ac-4359-b417-c18a7e0dec76": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 690,
          "y": 510
        },
        "z": 3,
        "parent": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754",
        "embeds": [],
        "references": [
          "6764dff7-08a4-419e-8209-f3bbf436cfa2"
        ]
      },
      "ee612472-ef50-47e5-bc5b-f1cbd4c74a12": {
        "source": {
          "id": "6c1ca4ea-f6ac-4359-b417-c18a7e0dec76"
        },
        "target": {
          "id": "6764dff7-08a4-419e-8209-f3bbf436cfa2"
        },
        "z": 4
      },
      "797a7c67-8e47-450c-bd9b-c1ffe8a3a875": {
        "source": {
          "id": "204bcb90-a980-47be-988e-82b9cb8728ff"
        },
        "target": {
          "id": "6764dff7-08a4-419e-8209-f3bbf436cfa2"
        },
        "z": 5
      },
      "a50fedce-c8c0-485f-a5c6-d28a94486d72": {
        "source": {
          "id": "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4"
        },
        "target": {
          "id": "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a"
        },
        "z": 4
      },
      "fff16b65-15e4-4459-b0f8-f3e3be770db3": {
        "source": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        },
        "target": {
          "id": "9c17329e-4f0e-498c-83c3-c039080890ae"
        },
        "z": 4
      }
    }
  },
  "Resources": {
    "elasticSearchVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {
          "Ref": "elasticSearchCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "Elastic Search VPC"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "36f27655-c4ae-407e-9185-381293f6bb93"
        }
      }
    },
    "EC2VPCG1FYBK": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "elasticSearchIGW"
        },
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d03f5fa0-6289-41e3-95ec-5c2d1a29454b"
        }
      }
    },
    "elasticSearchIGW": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "efdb307b-1972-4dd1-8755-85726629a1d5"
        }
      }
    },
    "elasticSearchPublicSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "AvailabilityZone": {
          "Ref": "availabilityZone"
        },
        "CidrBlock": {
          "Ref": "publicESCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ElasticSearch public network"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "9c17329e-4f0e-498c-83c3-c039080890ae"
        }
      }
    },
    "elasticSearchPrivateSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "AvailabilityZone": {
          "Ref": "availabilityZone"
        },
        "CidrBlock": {
          "Ref": "privateESCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ElasticSearch private network"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "86f119d8-9e7c-4a19-b17b-ed664b9e73f0"
        }
      }
    },
    "elasticSearchNATEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "dea40fb2-4fff-4269-b920-c2a835260ce2"
        }
      }
    },
    "elasticSearchNAT": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPublicSubnet"
        },
        "AllocationId": {
          "Fn::GetAtt": [
            "elasticSearchNATEIP",
            "AllocationId"
          ]
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7ee2e03c-6a8b-4142-80d6-ae4cb40ab631"
        }
      }
    },
    "elasticSearchPublicRoutingTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a3d5bcd2-27eb-4fa1-a482-660bd25e6d93"
        }
      }
    },
    "elasticSearchPublicToInternet": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPublicRoutingTable"
        },
        "GatewayId": {
          "Ref": "elasticSearchIGW"
        },
        "DestinationCidrBlock": "0.0.0.0/0"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1abf5360-b03d-4e60-81d3-ae316698c8cc"
        }
      }
    },
    "EC2SRTA2Z4YE": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPublicRoutingTable"
        },
        "SubnetId": {
          "Ref": "elasticSearchPublicSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ef869242-a412-4346-973c-a531e3d98d8a"
        }
      }
    },
    "elasticSearch1": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es1.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "88279449-ada4-404c-8850-88f539acedbb"
        }
      }
    },
    "elasticSearch2": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es2.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a5f4cc39-425f-45e7-9bc7-b42ac1e0532d"
        }
      }
    },
    "elasticSearch3": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        },
        "ImageId": {
          "Ref": "elasticSearchAMI"
        },
        "InstanceType": {
          "Ref": "elasticSearchInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "es3.example.com"
          },
          {
            "Key": "system",
            "Value": "elasticsearch-node"
          },
          {
            "Key": "application",
            "Value": "elasticsearch-cluster"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "elasticSearchSG"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6bb5f648-cc4b-443d-a76d-ed727afa58d4"
        }
      }
    },
    "elasticSearchSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "GroupDescription": "Elastic Search internal traffic",
        "SecurityGroupIngress": [
          {
            "CidrIp": {
              "Ref": "elasticSearchCIDR"
            },
            "IpProtocol": "-1"
          },
          {
            "CidrIp": {
              "Ref": "publicjumpCIDR"
            },
            "IpProtocol": "-1"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "aab61a65-9b7c-4906-80f2-8eaea438557f"
        }
      }
    },
    "elasticSearchPrivateRoutingTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "7d37bee4-c21b-4c5e-b642-1bfaaa7f1754"
        }
      }
    },
    "elasticSearchPrivateToInternet": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPrivateRoutingTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "elasticSearchNAT"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "edc623d7-287d-463c-8da4-d26285107199"
        }
      }
    },
    "EC2SRTA3LBEE": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPrivateRoutingTable"
        },
        "SubnetId": {
          "Ref": "elasticSearchPrivateSubnet"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "60aaa6dc-1a58-4292-ad04-e7c603e06e05"
        }
      }
    },
    "elasticSearchELB": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Instances": [
          {
            "Ref": "elasticSearch3"
          },
          {
            "Ref": "elasticSearch2"
          },
          {
            "Ref": "elasticSearch1"
          }
        ],
        "HealthCheck": {
          "HealthyThreshold": 2,
          "Interval": 5,
          "Target": "TCP:9200",
          "Timeout": 4,
          "UnhealthyThreshold": 2
        },
        "LoadBalancerName": "es-cluster",
        "Scheme": "internet-facing",
        "Listeners": [
          {
            "InstancePort": "9200",
            "LoadBalancerPort": "9200",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "elbSG"
          }
        ],
        "Subnets": [
          {
            "Ref": "elasticSearchPublicSubnet"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "c47bdcca-003b-4704-b1b3-8bc050d64085"
        }
      }
    },
    "elbSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "GroupDescription": "ES ELB Allow port 9200",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "9200",
            "ToPort": "9200",
            "IpProtocol": "tcp"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b8e5368e-f7ee-4fc0-90a9-319d4c4382f5"
        }
      }
    },
    "jumpVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {
          "Ref": "jumpCIDR"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "jump VPC"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a18d69fd-8bab-477b-b86c-6350da5fdd1a"
        }
      }
    },
    "jumpPublic": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "jumpVPC"
        },
        "CidrBlock": {
          "Ref": "publicjumpCIDR"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e34b83d8-b7cc-4f09-9e93-ad43a4687f39"
        }
      }
    },
    "jump": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "SubnetId": {
          "Ref": "jumpPublic"
        },
        "SecurityGroupIds": [
          {
            "Ref": "jumpSG"
          }
        ],
        "ImageId": {
          "Ref": "jumpAMI"
        },
        "InstanceType": {
          "Ref": "jumpInstanceType"
        },
        "KeyName": {
          "Ref": "keyPairName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "jump.example.com"
          },
          {
            "Key": "system",
            "Value": "jump"
          },
          {
            "Key": "application",
            "Value": "bastion"
          },
          {
            "Key": "env",
            "Value": {
              "Ref": "env"
            }
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": "true",
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d74a4cb2-752b-4ee2-b6f6-88e33c30dfd4"
        }
      },
      "DependsOn": [
        "jumpEIP"
      ]
    },
    "EC2EIPA1IKOY": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": {
          "Ref": "jumpEIP"
        },
        "InstanceId": {
          "Ref": "jump"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "4a1a9faa-5c5c-40b2-8bbf-ccd05e679abe"
        }
      }
    },
    "jumpEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f9c7fda5-b25a-42ba-9dba-ed7abe61e85a"
        }
      }
    },
    "jumpSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "jumpVPC"
        },
        "GroupDescription": "jump allow all",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "551146b6-9da7-4507-b56a-169a698b8a74"
        }
      }
    },
    "EC2IG38AZP": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {},
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0ce14ddf-1960-435a-a4f4-5212a93321ad"
        }
      }
    },
    "EC2VPCG2VXMB": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "EC2IG38AZP"
        },
        "VpcId": {
          "Ref": "jumpVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a5158102-ea7d-4b41-8efa-f94cc5ff8c0f"
        }
      }
    },
    "jumpPublicRoutingTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "jumpVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f1a4dec2-a9cc-4087-9a66-1b9f24d1f80e"
        }
      }
    },
    "EC2SRTA2CFC4": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "jumpPublicRoutingTable"
        },
        "SubnetId": {
          "Ref": "jumpPublic"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b03e3f82-bf90-4607-ab2b-eb6b54826fd6"
        }
      }
    },
    "jumpToInternet": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "jumpPublicRoutingTable"
        },
        "GatewayId": {
          "Ref": "EC2IG38AZP"
        },
        "DestinationCidrBlock": "0.0.0.0/0"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "ce415937-fc09-48d1-98fd-809f3e05005e"
        }
      }
    },
    "EC2VPCPAB2P": {
      "Type": "AWS::EC2::VPCPeeringConnection",
      "Properties": {
        "VpcId": {
          "Ref": "elasticSearchVPC"
        },
        "PeerVpcId": {
          "Ref": "jumpVPC"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6764dff7-08a4-419e-8209-f3bbf436cfa2"
        }
      }
    },
    "jumpToESVPC": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "jumpPublicRoutingTable"
        },
        "VpcPeeringConnectionId": {
          "Ref": "EC2VPCPAB2P"
        },
        "DestinationCidrBlock": {
          "Ref": "privateESCIDR"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "204bcb90-a980-47be-988e-82b9cb8728ff"
        }
      }
    },
    "EStoJumpVPC": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "elasticSearchPrivateRoutingTable"
        },
        "VpcPeeringConnectionId": {
          "Ref": "EC2VPCPAB2P"
        },
        "DestinationCidrBlock": {
          "Ref": "publicjumpCIDR"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "6c1ca4ea-f6ac-4359-b417-c18a7e0dec76"
        }
      }
    }
  },
  "Parameters": {
    "availabilityZone": {
      "Type": "String"
    },
    "privateESCIDR": {
      "Type": "String"
    },
    "publicESCIDR": {
      "Type": "String"
    },
    "elasticSearchCIDR": {
      "Type": "String"
    },
    "elasticSearchAMI": {
      "Type": "String"
    },
    "elasticSearchInstanceType": {
      "Type": "String"
    },
    "env": {
      "Type": "String"
    },
    "keyPairName": {
      "Type": "String"
    },
    "jumpCIDR": {
      "Type": "String"
    },
    "publicjumpCIDR": {
      "Type": "String"
    },
    "jumpAMI": {
      "Type": "String"
    },
    "jumpInstanceType": {
      "Type": "String"
    }
  }
}